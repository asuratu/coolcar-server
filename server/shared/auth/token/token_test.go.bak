package token

import (
	"fmt"
	"github.com/dgrijalva/jwt-go"
	"testing"
	"time"
)

const subject = "6294998159f23ab9ce8864a3"
const publicKey = `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6pa4YwAU3emF25RJPS99
WrPH+jIoYBReninyED0saYAEBfRSkvG32gKdqcR7daRsve34l8hHriKdheP2AtQU
bw1sK/mDTpYtyCyfAogXJBsgfXA5F7Dzn82+sbSDdfKgMWxvpdUKfQF94G79tzf/
6qGTfOmkcttQ8ekvt1+J4apZu8iSaME8YFtERypSGi9Ol7JJ1Ut9uW7qkivtwsHs
MSmCiubwJYDK8CW566H1rJeXzzGH1f4oPTgE/pEiUiZ7t2y56wPt1lvJ6iMfaD/U
Yl2/thZscR7yXnAFN6gSQLWtScU4rtdlD/BSguDXByqQYQU0I3MIzIcuJmQetOLW
SQIDAQAB
-----END PUBLIC KEY-----`
const token = "eyJhbGciOiJSUzUxMiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NTQwODUzNTEsImlhdCI6MTY1NDA3ODE1MSwiaXNzIjoiY29vbGNhci9hdXRoIiwic3ViIjoiNjI5NDk5ODE1OWYyM2FiOWNlODg2NGEzIn0.DhXU5o-T3VFWZEPGcqSy8iFMiGJ6JfpPc3arIWKJLFw_0UUHE6C24WF6Ngg8NCvd7uVtiA6bULKxGhkslLZKdX1ufqDkM5TD-FIZzqSD22KCCcy9O32Ak9dUFffgj9xAwwZ1FrwY-iOFcesYSeSbOriPGQLwfDVJMBeeWIR5qiNTbeVFPn2A4EPXtUIBNS_u8YmD6SddVmcNobwscZ7x08I8zDTnkUbdXivsFZf3NJDMn5TLhbhof_VCq_tj1819qbotZyvMqaSrrMmwYCwlaiW1_5RSR32xe95ii05QjxKdyknJ4ODebFwSyacz7RlcOyptK7ZbbiyvpSMqjXhtew"

func TestVerify(t *testing.T) {
	pubKey, err := jwt.ParseRSAPublicKeyFromPEM([]byte(publicKey))
	if err != nil {
		t.Fatalf("cannot parse public key: %v", err)
	}
	v := &JWTTokenVerifier{
		PublicKey: pubKey,
	}

	// 控制JWT的时间，设置当前时间
	jwt.TimeFunc = func() time.Time {
		return time.Unix(1654078251, 0)
	}

	accountID, err := v.Verify(token)
	if err != nil {
		fmt.Println(err)
		t.Errorf("cannot verify token: %v", err)
	}

	if accountID != subject {
		t.Errorf("got accountID %s, want %s", accountID, subject)
	}
}
